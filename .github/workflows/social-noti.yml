name: Update Social Noti JSON

on:
  schedule:
    - cron: "*/15 * * * *" # every 15 minutes
  workflow_dispatch: {}     # allow manual run

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-json:
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      TZ: Asia/Kuala_Lumpur
      NODE_OPTIONS: --dns-result-order=ipv4first

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pg
        run: npm i pg

      - name: Build social noti
        env:
          NODE_OPTIONS: --dns-result-order=ipv4first
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          node -v
          node scripts/build_social_noti.js

      - name: Commit & push if changed
        id: auto-commit-action
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: refresh social_noti.json (automated)"
          file_pattern: data/social_noti.json

      - name: Wait for GitHub to process commit
        if: steps.auto-commit-action.outputs.changes_detected == 'true'
        run: sleep 10

      - name: Purge jsDelivr cache (only if updated)
        if: steps.auto-commit-action.outputs.changes_detected == 'true'
        run: |
          echo "Purging jsDelivr cache for social_noti.json..."
          
          # Purge @main branch reference
          for i in {1..3}; do
            echo "Purge attempt $i for @main"
            if curl -fsSL "https://purge.jsdelivr.net/gh/luqtech-official/kelasgpt-public-resources@main/data/social_noti.json"; then
              echo "✓ Successfully purged @main cache"
              break
            else
              echo "✗ Purge attempt $i failed"
              [ $i -lt 3 ] && sleep 5
            fi
          done
          
          # Also purge without branch reference (default)
          for i in {1..3}; do
            echo "Purge attempt $i for default"
            if curl -fsSL "https://purge.jsdelivr.net/gh/luqtech-official/kelasgpt-public-resources/data/social_noti.json"; then
              echo "✓ Successfully purged default cache"
              break
            else
              echo "✗ Purge attempt $i failed"
              [ $i -lt 3 ] && sleep 5
            fi
          done
          
          echo "Cache purge completed"

      - name: Verify cache update
        if: steps.auto-commit-action.outputs.changes_detected == 'true'
        run: |
          echo "Waiting 5 seconds for CDN propagation..."
          sleep 5
          
          echo "Fetching current CDN version..."
          curl -fsSL "https://cdn.jsdelivr.net/gh/luqtech-official/kelasgpt-public-resources@main/data/social_noti.json" | head -c 200
          
          echo ""
          echo "Note: Full CDN propagation may take a few minutes"
